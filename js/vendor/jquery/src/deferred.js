define(["./core","./var/isFunction","./var/slice","./callbacks"],function(s,u,a){"use strict";function d(e){return e}function h(e){throw e}function l(e,n,t,r){var o;try{e&&u(o=e.promise)?o.call(e).done(n).fail(t):e&&u(o=e.then)?o.call(e,n,t):n.apply(void 0,[e].slice(r))}catch(e){t.apply(void 0,[e])}}return s.extend({Deferred:function(e){var i=[["notify","progress",s.Callbacks("memory"),s.Callbacks("memory"),2],["resolve","done",s.Callbacks("once memory"),s.Callbacks("once memory"),0,"resolved"],["reject","fail",s.Callbacks("once memory"),s.Callbacks("once memory"),1,"rejected"]],o="pending",c={state:function(){return o},always:function(){return a.done(arguments).fail(arguments),this},catch:function(e){return c.then(null,e)},pipe:function(){var o=arguments;return s.Deferred(function(r){s.each(i,function(e,n){var t=u(o[n[4]])&&o[n[4]];a[n[1]](function(){var e=t&&t.apply(this,arguments);e&&u(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[n[0]+"With"](this,t?[e]:arguments)})}),o=null}).promise()},then:function(n,t,r){var l=0;function f(o,i,c,a){return function(){function e(){var e,n;if(!(o<l)){if((e=c.apply(t,r))===i.promise())throw new TypeError("Thenable self-resolution");n=e&&("object"==typeof e||"function"==typeof e)&&e.then,u(n)?a?n.call(e,f(l,i,d,a),f(l,i,h,a)):(l++,n.call(e,f(l,i,d,a),f(l,i,h,a),f(l,i,d,i.notifyWith))):(c!==d&&(t=void 0,r=[e]),(a||i.resolveWith)(t,r))}}var t=this,r=arguments,n=a?e:function(){try{e()}catch(e){s.Deferred.exceptionHook&&s.Deferred.exceptionHook(e,n.stackTrace),l<=o+1&&(c!==h&&(t=void 0,r=[e]),i.rejectWith(t,r))}};o?n():(s.Deferred.getStackHook&&(n.stackTrace=s.Deferred.getStackHook()),window.setTimeout(n))}}return s.Deferred(function(e){i[0][3].add(f(0,e,u(r)?r:d,e.notifyWith)),i[1][3].add(f(0,e,u(n)?n:d)),i[2][3].add(f(0,e,u(t)?t:h))}).promise()},promise:function(e){return null!=e?s.extend(e,c):c}},a={};return s.each(i,function(e,n){var t=n[2],r=n[5];c[n[1]]=t.add,r&&t.add(function(){o=r},i[3-e][2].disable,i[3-e][3].disable,i[0][2].lock,i[0][3].lock),t.add(n[3].fire),a[n[0]]=function(){return a[n[0]+"With"](this===a?void 0:this,arguments),this},a[n[0]+"With"]=t.fireWith}),c.promise(a),e&&e.call(a,a),a},when:function(e){function n(n){return function(e){o[n]=this,i[n]=1<arguments.length?a.call(arguments):e,--t||c.resolveWith(o,i)}}var t=arguments.length,r=t,o=Array(r),i=a.call(arguments),c=s.Deferred();if(t<=1&&(l(e,c.done(n(r)).resolve,c.reject,!t),"pending"===c.state()||u(i[r]&&i[r].then)))return c.then();for(;r--;)l(i[r],n(r),c.reject);return c.promise()}}),s});